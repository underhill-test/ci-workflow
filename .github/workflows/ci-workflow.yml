name: Common CI Workflow

on:
  workflow_call:
    inputs:
      run-translations:
        required: true
        type: boolean
      pack:
        required: true
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
    
    - name: Install dependencies
      run: | 
        npm install @octokit/auth-app
        npm install @actions/core

    - name: Run translations
      if: ${{ inputs.run-translations }}
      run: echo "running translations"

    - name: Pack
      if: ${{ inputs.pack }}
      run: echo "packing library"

    - name: Get Installation Access Token
      id: get_installation_token
      env:
        APP_ID: ${{ secrets.APP_ID_2 }}
        INSTALLATION_ID: ${{ secrets.INSTALLATION_ID_2 }}
        PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY_2 }}
      run: | 
        node -e "
          const { createAppAuth } = require('@octokit/auth-app');
          const core = require('@actions/core');

          async function getInstallationToken() {
            const auth = createAppAuth({
              appId: process.env.APP_ID,
              privateKey: process.env.PRIVATE_KEY
            });

            const authentication = await auth({ type: 'installation', installationId: process.env.INSTALLATION_ID });
            const token = authentication.token;

            core.setOutput('token', token);
          }

          getInstallationToken();
        "

    - name: Notify author on failure
      if: ${{ failure() }}
      uses: actions/github-script@v6
      with:
        github-token: ${{ steps.get_installation_token.outputs.token }}
        script: |
          const prNumber = context.payload.pull_request.number;
          const prAuthor = context.payload.pull_request.user.login;
          const repoOwner = context.repo.owner;
          const repoName = context.repo.repo;
          await github.rest.issues.createComment({
            owner: repoOwner,
            repo: repoName,
            issue_number: prNumber,
            body: `@${prAuthor}, the workflow has failed. Please check the logs for details.`
          });